<!DOCTYPE html>
<html lang="en">
<!-- Head -->
{% include ".head.html" %}

<body>
    <!-- Nav -->
    {% include ".header.html" %}

    <!-- Main -->
    <div class="container py-4">
        <!-- Logs Card -->
        <div class="card rounded">
            <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="mb-0">
                    System Logs
                    <span class="badge bg-primary ms-2">{{ system_logs | length }}</span>
                </h5>
                <i class="fas fa-file-alt text-primary fs-4"></i>
            </div>
            <div class="card-body p-3">
                <!-- Filters -->
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label for="log-level-filter" class="form-label small text-uppercase rounded">Level</label>
                        <select class="form-select form-select-sm rounded" id="log-level-filter">
                            <option value="all" selected>All Levels</option>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="log-service-filter" class="form-label small text-uppercase">Service</label>
                        <select class="form-select form-select-sm" id="log-service-filter">
                            <option value="all" selected>
                                All Services
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Logs Window -->
                <div id="log-window" class="border rounded p-2" style="max-height: 500px; overflow-y: auto">
                    <!-- Log entries injected by JavaScript -->
                </div>
            </div>
            <div class="card-footer bg-white">
                <button class="btn btn-outline-primary" id="btn-scroll-bottom">
                    <i class="fas fa-arrow-down me-2"></i>Scroll to Bottom
                </button>
            </div>
        </div>
    </div>

    <script id="logs-data" type="application/json">
            {{ system_logs | tojson | safe }}
        </script>

    <script>
        const logs = JSON.parse(
            document.getElementById("logs-data").textContent
        );

        function getUniqueServices(logs) {
            return [...new Set(logs.map((log) => log.service))].sort();
        }

        function parseLogEntry(log) {
            return {
                timestamp: log.timestamp.trim(),
                level: log.level.trim(),
                service: log.service.trim(),
                message: log.message.trim(),
            };
        }

        function populateServiceFilter() {
            const serviceFilter =
                document.getElementById("log-service-filter");
            getUniqueServices(logs).forEach((service) => {
                const option = document.createElement("option");
                option.value = service.toLowerCase();
                option.textContent = service;
                serviceFilter.appendChild(option);
            });
        }

        function displayLogs(
            logs,
            levelFilter = "all",
            serviceFilter = "all"
        ) {
            const logWindow = document.getElementById("log-window");
            logWindow.innerHTML = "";

            logs.forEach((log) => {
                const entry = parseLogEntry(log);
                const matchesLevel =
                    levelFilter === "all" ||
                    levelFilter === entry.level.toLowerCase();
                const matchesService =
                    serviceFilter === "all" ||
                    serviceFilter === entry.service.toLowerCase();
                if (!matchesLevel || !matchesService) return;

                const row = document.createElement("div");
                row.className =
                    "d-flex justify-content-between align-items-start mb-2 p-2 rounded bg-white shadow-sm";

                const leftCol = document.createElement("div");
                leftCol.className = "text-muted small me-3";
                leftCol.textContent = entry.timestamp;

                const middleCol = document.createElement("div");
                middleCol.className = `badge bg-${getLevelColor(
                    entry.level
                )} me-2`;
                middleCol.textContent = entry.level.toUpperCase();

                const rightCol = document.createElement("div");
                rightCol.className = "flex-grow-1";
                rightCol.innerHTML = `<strong>${entry.service}</strong>: ${entry.message}`;

                row.appendChild(leftCol);
                row.appendChild(middleCol);
                row.appendChild(rightCol);

                logWindow.appendChild(row);
            });

            scrollToBottom();
        }

        function getLevelColor(level) {
            switch (level.toLowerCase()) {
                case "debug":
                    return "secondary";
                case "info":
                    return "info";
                case "warning":
                    return "warning";
                case "error":
                    return "danger";
                default:
                    return "secondary";
            }
        }

        function scrollToBottom() {
            const logWindow = document.getElementById("log-window");
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        document.addEventListener("DOMContentLoaded", function () {
            bootstrap.Tooltip &&
                [].slice
                    .call(
                        document.querySelectorAll(
                            '[data-bs-toggle="tooltip"]'
                        )
                    )
                    .map((el) => new bootstrap.Tooltip(el));

            populateServiceFilter();
            displayLogs(logs);

            const logWindow = document.getElementById("log-window");
            const levelFilter = document.getElementById("log-level-filter");
            const serviceFilter =
                document.getElementById("log-service-filter");

            levelFilter.addEventListener("change", () =>
                displayLogs(logs, levelFilter.value, serviceFilter.value)
            );
            serviceFilter.addEventListener("change", () =>
                displayLogs(logs, levelFilter.value, serviceFilter.value)
            );
            document
                .getElementById("btn-scroll-bottom")
                .addEventListener("click", scrollToBottom);
        });
    </script>
</body>

</html>
