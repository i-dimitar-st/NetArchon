{% from 'macros/icons.jinja2' import icons %}

<!DOCTYPE html>
<html lang="en">

{% include ".head.html" %}

<body>
    {% include ".header.html" %}
    <div class="container py-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold text-capitalize" style="color:var(--text-secondary)">
                    Logs
                    <span class="badge badge-index">{{ system_logs | length }}</span>
                </h5>
                <span style="color:var(--primary-color)">{{ icons("log") }}</span>
            </div>
            <div class="card-body p-3">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label for="log-level-filter" class="form-label small text-uppercase rounded">Level</label>
                        <select class="form-select form-select-sm rounded" id="log-level-filter">
                            <option value="all" selected>All Levels</option>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="log-service-filter" class="form-label small text-uppercase">Service</label>
                        <select class="form-select form-select-sm" id="log-service-filter">
                            <option value="all" selected>
                                All Services
                            </option>
                        </select>
                    </div>
                </div>
                <div id="log-window" class="border rounded p-2" style="overflow-y:auto;max-height:500px">
                    <!-- Log entries -->
                </div>
            </div>
            <div class="card-footer bg-white">
                <button class="btn button-custom" id="btn-scroll-bottom">
                    {{ icons("arrow-down") }}
                    To Bottom
                </button>
            </div>
        </div>
    </div>
    {# Yeah otherwise linter complains #}
    <script id="logs-data" type="application/json">
            {{ system_logs | tojson | safe }}
    </script>
    <script>
        const logs = JSON.parse(document.getElementById("logs-data").textContent);

        function getUniqueServices(logs) {
            return [...new Set(logs.map((log) => log.service))].sort();
        }

        function parseLogEntry(log) {
            return {
                timestamp: log.timestamp.trim(),
                level: log.level.trim(),
                service: log.service.trim(),
                message: log.message.trim(),
            };
        }

        function populateServiceFilter() {
            const serviceFilter = document.getElementById("log-service-filter");
            getUniqueServices(logs).forEach((service) => {
                const option = document.createElement("option");
                option.value = service.toLowerCase();
                option.textContent = service;
                serviceFilter.appendChild(option);
            });
        }

        function displayLogs(
            logs,
            levelFilter = "all",
            serviceFilter = "all"
        ) {
            const logWindow = document.getElementById("log-window");
            logWindow.innerHTML = "";

            logs.forEach((log) => {
                const entry = parseLogEntry(log);
                const matchesLevel =
                    levelFilter === "all" ||
                    levelFilter === entry.level.toLowerCase();
                const matchesService =
                    serviceFilter === "all" ||
                    serviceFilter === entry.service.toLowerCase();
                if (!matchesLevel || !matchesService) return;

                const row = document.createElement("div");
                row.className =
                    "d-flex justify-content-between align-items-start mb-2 p-2 rounded bg-white shadow-sm";

                const timestamp = document.createElement("div");
                timestamp.className = "text-muted small me-3";
                timestamp.textContent = entry.timestamp;

                const level = document.createElement("div");
                level.className = `badge bg-${getLevelColor(entry.level)} me-2`;
                level.textContent = entry.level.toUpperCase();

                const logContent = document.createElement("div");
                logContent.className = "flex-grow-1";
                logContent.innerHTML = `<strong>${entry.service}</strong>: ${entry.message}`;

                row.appendChild(timestamp);
                row.appendChild(level);
                row.appendChild(logContent);

                logWindow.appendChild(row);
            });

            scrollToBottom();
        }

        function getLevelColor(level) {
            switch (level.toLowerCase()) {
                case "debug":
                    return "secondary";
                case "info":
                    return "info";
                case "warning":
                    return "warning";
                case "error":
                    return "danger";
                default:
                    return "secondary";
            }
        }

        function scrollToBottom() {
            const logWindow = document.getElementById("log-window");
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        document.addEventListener("DOMContentLoaded", function () {
            bootstrap.Tooltip &&
                [].slice
                    .call(
                        document.querySelectorAll(
                            '[data-bs-toggle="tooltip"]'
                        )
                    )
                    .map((el) => new bootstrap.Tooltip(el));

            populateServiceFilter();
            displayLogs(logs);

            const logWindow = document.getElementById("log-window");
            const levelFilter = document.getElementById("log-level-filter");
            const serviceFilter =
                document.getElementById("log-service-filter");

            levelFilter.addEventListener("change", () =>
                displayLogs(logs, levelFilter.value, serviceFilter.value)
            );
            serviceFilter.addEventListener("change", () =>
                displayLogs(logs, levelFilter.value, serviceFilter.value)
            );
            document
                .getElementById("btn-scroll-bottom")
                .addEventListener("click", scrollToBottom);
        });
    </script>
</body>

</html>
